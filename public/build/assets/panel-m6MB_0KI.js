import{a as F}from"./index-NIGUFBhG.js";import{P as en,E as tn}from"./pusher-BoS8NtKK.js";import{g as nn}from"./_commonjsHelpers-CqkleIqs.js";F.defaults.headers.common["X-CSRF-TOKEN"]=document.querySelector('meta[name="csrf-token"]').content;F.defaults.headers.common["Content-Type"]="application/json";let ie=[];window.selectedChatId=null;let Ye,Y,ze,Le;window.addEventListener("load",function(){initChatSection()});window.initChatSection=()=>{Ye=document.getElementById("app-container"),Y=document.getElementById("chat-items-container"),ze=document.getElementById("chat-window-panel"),Le=document.getElementById("menu-button"),!(!Y||!ze)&&fetchChats()};window.fetchChats=async function(){try{if(ie=await(await fetch("/chat/get_chats")).json(),renderChatList(),window.subscribeToChats&&window.subscribeToChats(ie),window.selectedChatId){const a=ie.find(r=>r.id===window.selectedChatId);a&&window.renderMessages(a.messages)}}catch(i){console.error("Error al cargar chats:",i)}};const xt=i=>{const a=document.createElement("div");a.className=`flex items-center p-4 border-b border-gray-200 cursor-pointer hover:bg-gray-100 transition-colors duration-200 ${i.isUnread?"bg-blue-50":""}`,a.dataset.chatId=i.id;let r="";return i.isUnread&&(r='<div class="w-2.5 h-2.5 bg-blue-500 rounded-full ml-auto"></div>'),a.innerHTML=`
        <img src="${i.avatar}" alt="${i.name}" class="w-12 h-12 rounded-full mr-4" 
             onerror="this.onerror=null;this.src='https://placehold.co/100x100/A3A3A3/FFFFFF?text=U';">
        <div class="flex-1 overflow-hidden">
            <h3 class="font-semibold text-sm truncate">${i.name}</h3>
            <p class="text-gray-500 text-xs truncate">${i.lastMessage}</p>
        </div>
        ${r}
    `,a.addEventListener("click",()=>on(i.id)),a};window.renderChatList=()=>{Y.innerHTML="",ie.forEach(i=>Y.appendChild(xt(i)))};const an=i=>{const r=document.getElementById("chat-window-template").content.cloneNode(!0),u=r.querySelector(".chat-avatar"),f=r.querySelector(".chat-name"),v=r.querySelector(".ai-manual-toggle"),C=r.querySelector(".label-ia"),L=r.querySelector(".label-manual"),B=r.querySelector(".toggle-container");u.src=i.avatar,f.textContent=i.name;const _=M=>{v.checked=M,M?(L.classList.add("hidden"),C.classList.remove("hidden"),B.classList.add("is-breathing")):(L.classList.remove("hidden"),C.classList.add("hidden"),B.classList.remove("is-breathing"))};_(i.control_status==1);const H=document.getElementById("changeStatusModal"),A=document.getElementById("statusName"),W=document.getElementById("confirmChangeStatusBtn"),ce=document.getElementById("cancelChangeStatusBtn"),K=document.getElementById("closeChangeStatusModal");return v.addEventListener("click",M=>{M.preventDefault();const D=v.checked?"Agente IA":"Manual";A.textContent=D,H.classList.remove("hidden"),W.onclick=()=>{v.disabled=!0,W.disabled=!0,ce.disabled=!0,K.disabled=!0,W.innerHTML='<span class="loader"></span>',F.post(`/chat/toggle_status/${i.id}`).then(()=>{const oe=!v.checked;_(oe),H.classList.add("hidden")}).catch(oe=>{console.error("Error al actualizar estado:",oe)}).finally(()=>{v.disabled=!1,W.disabled=!1,ce.disabled=!1,K.disabled=!1,W.innerHTML="Confirmar"})};const Ee=()=>H.classList.add("hidden");ce.onclick=Ee,K.onclick=Ee}),r};window.renderMessages=i=>{const a=document.getElementById("messages-container");a&&(a.innerHTML="",i.forEach(r=>{const u=De({id:r.id,message:r.text,currentdate:r.date,client_message:r.sender==="user"?0:1,status:"sent"});a.appendChild(u)}),setTimeout(()=>{a.scrollTop=a.scrollHeight},0))};const on=i=>{window.selectedChatId=i;const a=ie.find(v=>v.id===i);if(!a)return;a.isUnread=!1,window.updateChatListDOM(),window.updateDocumentTitle(),ze.innerHTML="",document.getElementById("chat-window-panel").appendChild(an(a)),window.renderMessages(a.messages);const r=document.getElementById("message-input"),u=document.getElementById("send-button"),f=document.getElementById("back-button");u.addEventListener("click",at),r.addEventListener("keydown",v=>{v.key==="Enter"&&at()}),f.addEventListener("click",rn),Ye.classList.add("chat-active"),highlightSelectedItem("[data-chat-id]",i),Ct()};let Se=null;const at=async()=>{const i=document.getElementById("message-input"),a=i.value.trim();if(!a||!window.selectedChatId)return;i.value="",Se||(Se=performance.now());const r=Date.now(),u={id:r,conversation_id:window.selectedChatId,message:a,currentdate:new Date().toISOString(),status:"sending",client_message:0};window.addMessageToChat&&window.addMessageToChat(u);try{await F.post("/chat/send_message",{conversation_id:window.selectedChatId,message:a,temp_id:r})}catch(f){console.error("Error al enviar mensaje:",f),window.updateMessageStatus&&window.updateMessageStatus(r,"error")}};window.replaceTempMessage=i=>{if(!i.temp_id)return!1;const a=document.querySelector(`[data-id='${i.temp_id}']`);if(a){const r=De(i);return r.dataset.id=i.id,a.replaceWith(r),!0}return!1};window.updateMessageStatus=(i,a)=>{const r=document.querySelector(`[data-id='${i}']`);if(r){r.remove();const u=De({id:i,message:r.textContent.trim(),status:a});r.replaceWith(u)}};const rn=()=>{window.selectedChatId=null,Ye.classList.remove("chat-active"),Ct()};window.addMessageToChat=i=>{if(window.selectedChatId&&window.selectedChatId==i.conversation_id){const a=document.getElementById("messages-container");if(a){const r=De(i);r.dataset.id=i.id,a.appendChild(r),a.scrollTop=a.scrollHeight}}};const De=i=>{const a=document.createElement("div");a.className=`flex ${i.client_message===0?"justify-end":"justify-start"}`;const r=document.createElement("div");if(r.className=`
        max-w-xs md:max-w-md p-3 rounded-xl
        ${i.client_message===0?"bg-sky-700 text-white rounded-br-none":"bg-white text-gray-800 rounded-bl-none"}
        relative min-w-10
    `,i.status==="sending"&&(r.classList.add("bubble-breathing"),Se)){const _=-((performance.now()-Se)%1e3)/1e3;r.style.animationDelay=`${_}s`}const u=new Date(i.currentdate||Date.now()),f=u.getHours().toString().padStart(2,"0"),v=u.getMinutes().toString().padStart(2,"0");return r.innerHTML=`
        <p class="text-sm mb-2 break-words">${i.message}</p>
        <span class="text-[10px] ${i.client_message===0?"text-gray-100":"text-gray-400"} absolute bottom-1 right-2">
            ${f}:${v}
        </span>
    `,a.appendChild(r),i.id&&(a.dataset.id=i.id),a};window.updateChatListDOM=()=>{const i=Array.from(Y.children),a=new Map;i.forEach(r=>{a.set(parseInt(r.dataset.chatId),r)}),Y.innerHTML="",ie.forEach(r=>{let u=a.get(r.id);if(u){const f=u.querySelector("p.text-gray-500");f&&(f.textContent=r.lastMessage),u.className=`flex items-center p-4 border-b border-gray-200 cursor-pointer hover:bg-gray-100 transition-colors duration-200 ${r.isUnread?"bg-blue-50":""}`,highlightSelectedItem("[data-chat-id]",window.selectedChatId);const v=u.querySelector(".bg-blue-500.rounded-full");if(r.isUnread&&!v){const C=document.createElement("div");C.className="w-2.5 h-2.5 bg-blue-500 rounded-full ml-auto",u.appendChild(C)}else!r.isUnread&&v&&v.remove();Y.appendChild(u)}else Y.appendChild(xt(r))})};window.updateDocumentTitle=()=>{const i=ie.filter(r=>r.isUnread).length,a="Gyler Digital";i>0?document.title=`(${i}) ${a}`:document.title=a};const Ct=()=>{Le&&(window.selectedChatId?Le.classList.add("hidden"):Le.classList.remove("hidden"))};window.Pusher=en;window.Echo=new tn({broadcaster:"pusher",key:"2458967c63940f50992a",cluster:"sa1",forceTLS:!0,authEndpoint:"/broadcasting/auth"});const ot=new Set;window.subscribeToChats=i=>{i.forEach(a=>{ot.has(a.id)||(window.Echo.private(`chat.${a.id}`).listen(".NewMessage",r=>{const u=r.messages,f={id:u.id,text:u.message,sender:u.client_message===0?"user":"contact",date:u.currentdate},v=i.findIndex(C=>C.id===u.conversation_id);if(v>-1){const C=i[v];C.messages.push(f),C.lastMessage=u.message,C.currentdate=u.currentdate,window.selectedChatId!==C.id&&(C.isUnread=!0);const[L]=i.splice(v,1);i.unshift(L),window.updateChatListDOM(),window.updateDocumentTitle()}window.replaceTempMessage&&window.replaceTempMessage(u)||window.addMessageToChat&&window.addMessageToChat(u)}),ot.add(a.id))})};F.defaults.headers.common["X-CSRF-TOKEN"]=document.querySelector('meta[name="csrf-token"]').content;F.defaults.headers.common["Content-Type"]="application/json";let We,Ue,j,te,Te,ke,Ze,rt,Ve,Ie,q,st,lt,dt,Lt,z,It,ae=null,V=[];window.addEventListener("load",function(){initUserSection()});window.initUserSection=()=>{We=document.getElementById("openModal"),Ue=document.getElementById("closeAddModal"),j=document.getElementById("addUserModal"),te=document.getElementById("addUserForm"),Te=document.getElementById("errorName"),ke=document.getElementById("errorEmail"),Ze=document.getElementById("user-list"),rt=document.getElementById("user-detail-panel"),q=document.getElementById("deleteUserModal"),st=document.getElementById("closeDeleteModal"),lt=document.getElementById("confirmDeleteBtn"),dt=document.getElementById("cancelDeleteBtn"),Lt=document.getElementById("userNameToDelete"),z=document.getElementById("messageModal"),It=document.getElementById("messageText"),Ve=document.getElementById("app-container"),Ie=document.getElementById("menu-button"),!(!We||!Ue||!j)&&(We.addEventListener("click",()=>{j.classList.remove("hidden")}),Ue.addEventListener("click",()=>{j.classList.add("hidden"),te.reset(),Te.textContent="",ke.textContent=""}),j.addEventListener("click",i=>{i.target===j&&(j.classList.add("hidden"),te.reset())}),q.addEventListener("click",i=>{i.target===q&&q.classList.add("hidden")}),st.addEventListener("click",()=>{q.classList.add("hidden")}),lt.addEventListener("click",()=>{ae&&(V=V.filter(i=>i.id!==ae),Ke(),rt.innerHTML=`<div class="flex items-center justify-center h-full text-gray-500">
                                                <span class="hidden md:block text-lg">Selecciona un usuario</span>
                                            </div>`,ae=null,q.classList.add("hidden"),Ge("Usuario eliminado correctamente.","success"))}),dt.addEventListener("click",()=>{q.classList.add("hidden")}),sn(),te.addEventListener("submit",ln))};async function sn(){try{V=(await F.get("/panel/get_users")).data,Ke()}catch(i){console.error("Error al cargar usuarios:",i)}}function Ke(){Ze.innerHTML="",V.forEach(i=>{const a=document.createElement("div");a.className="user-list-item p-4 flex items-center space-x-4 border-b border-gray-200 cursor-pointer hover:bg-gray-100 transition-colors",a.dataset.userId=i.id,ae===i.id&&a.classList.add("active"),a.innerHTML=`
                    <div class="w-12 h-12 bg-gray-300 rounded-full flex items-center justify-center text-white font-bold text-lg">
                        ${i.name.charAt(0).toUpperCase()}
                    </div>
                    <div class="flex-1">
                        <div class="font-semibold text-gray-900">${i.name}</div>
                        <div class="text-sm text-gray-500">${i.email}</div>
                    </div>
                `,a.addEventListener("click",()=>dn(i.id)),Ze.appendChild(a)})}async function ln(i){i.preventDefault(),Te.textContent="",ke.textContent="";const a=te.querySelector('button[type="submit"]'),r=a.innerHTML;a.disabled=!0,a.innerHTML='<span class="loader"></span>';const u=new FormData(te);try{const v=(await F.post("/panel/store_user",{name:u.get("name"),email:u.get("email")})).data.user;V.unshift(v),Ke(),j.classList.add("hidden"),te.reset()}catch(f){if(f.response&&f.response.status===422){const v=f.response.data.errors;v.name&&(Te.textContent=v.name[0]),v.email&&(ke.textContent=v.email[0])}else alert("Ocurrió un error. Intenta nuevamente.")}finally{a.disabled=!1,a.innerHTML=r}}function dn(i){ae=i;const a=V.find(f=>f.id===i);if(!a)return;document.querySelectorAll(".user-list-item").forEach(f=>{f.classList.remove("active")});const r=document.querySelector(`[data-user-id="${i}"]`);r&&r.classList.add("active"),highlightSelectedItem("[data-user-id]",i),document.getElementById("back-button").addEventListener("click",hn),Ve.classList.add("user-active"),cn(a),Bt()}function cn(i){const a=document.getElementById("user-empty-state"),r=document.getElementById("user-detail-card");a.classList.add("hidden"),r.classList.remove("hidden"),document.getElementById("user-avatar").textContent=i.name.charAt(0).toUpperCase(),document.getElementById("user-name").textContent=i.name,document.getElementById("user-email").textContent=i.email,document.getElementById("user-password").textContent=i.password?"********":"Sin clave",document.getElementById("user-role").textContent=i.role??"Vendedor",document.getElementById("user-created").textContent=new Date(i.created_at).toLocaleDateString();const u=document.getElementById("deleteUserBtn");u.onclick=()=>mn(i);const f=document.getElementById("sendResetBtn");f.onclick=()=>fn(i.id),Xe()}function Xe(){document.querySelectorAll("[data-field]").forEach(i=>{i.addEventListener("dblclick",()=>un(i))})}function un(i){const a=i.dataset.id,r=i.dataset.field,u=i.textContent.trim(),f=r==="password",v=document.createElement("input");v.type="text",v.value=f?"":u,v.placeholder=f?"Nueva clave":"",v.className="w-full px-2 py-1 bg-gray-200 text-gray-900 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors";const C=i.parentElement;let L=!1;C.classList.contains("flex")&&(L=!0,i.style.flex="1",v.style.flex="1"),i.replaceWith(v),v.focus();const B=()=>{const _=v.value.trim(),H=V.find(W=>W.id==a),A=document.createElement("span");H&&(_!==""&&(H[r]=_),A.textContent=f?"********":_||u,A.className=i.className,A.dataset.field=r,A.dataset.id=a,v.replaceWith(A),L&&(A.style.flex="1"),_!==""&&_!==u&&Ge("Cambio guardado exitosamente.","success")),Xe()};v.addEventListener("blur",B),v.addEventListener("keydown",_=>{if(_.key==="Enter")v.removeEventListener("blur",B),B();else if(_.key==="Escape"){v.removeEventListener("blur",B);const H=document.createElement("span");H.textContent=u,H.className=i.className,H.dataset.field=r,H.dataset.id=a,v.replaceWith(H),Xe()}})}function mn(i){Lt.textContent=i.name,q.classList.remove("hidden")}function fn(i){const a=V.find(r=>r.id===i);a&&Ge(`Simulando envío de correo de restablecimiento de clave a ${a.email}`,"info")}function Ge(i,a="info"){It.textContent=i,a==="success"?(z.classList.remove("bg-gray-800"),z.classList.add("bg-green-600")):(z.classList.remove("bg-green-600"),z.classList.add("bg-gray-800")),z.classList.remove("hidden"),z.classList.add("animate-fade-in"),setTimeout(()=>{z.classList.add("hidden"),z.classList.remove("animate-fade-in")},3e3)}const hn=()=>{ae=null,Ve.classList.remove("user-active"),Bt()},Bt=()=>{Ie&&(ae?Ie.classList.add("hidden"):Ie.classList.remove("hidden"))};var he={exports:{}},pn=he.exports,ct;function gn(){return ct||(ct=1,function(i,a){(function(r,u){typeof a.nodeName!="string"?i.exports=u():r.Croppie=u()})(typeof self<"u"?self:pn,function(){if(typeof Promise!="function"){/*! promise-polyfill 3.1.0 */(function(e){function n(d,h){return function(){d.apply(h,arguments)}}function t(d){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");if(typeof d!="function")throw new TypeError("not a function");this._state=null,this._value=null,this._deferreds=[],y(d,n(l,this),n(s,this))}function o(d){var h=this;return this._state===null?void this._deferreds.push(d):void b(function(){var c=h._state?d.onFulfilled:d.onRejected;if(c===null)return void(h._state?d.resolve:d.reject)(h._value);var g;try{g=c(h._value)}catch(E){return void d.reject(E)}d.resolve(g)})}function l(d){try{if(d===this)throw new TypeError("A promise cannot be resolved with itself.");if(d&&(typeof d=="object"||typeof d=="function")){var h=d.then;if(typeof h=="function")return void y(n(h,d),n(l,this),n(s,this))}this._state=!0,this._value=d,m.call(this)}catch(c){s.call(this,c)}}function s(d){this._state=!1,this._value=d,m.call(this)}function m(){for(var d=0,h=this._deferreds.length;h>d;d++)o.call(this,this._deferreds[d]);this._deferreds=null}function p(d,h,c,g){this.onFulfilled=typeof d=="function"?d:null,this.onRejected=typeof h=="function"?h:null,this.resolve=c,this.reject=g}function y(d,h,c){var g=!1;try{d(function(E){g||(g=!0,h(E))},function(E){g||(g=!0,c(E))})}catch(E){if(g)return;g=!0,c(E)}}var w=setTimeout,b=typeof setImmediate=="function"&&setImmediate||function(d){w(d,1)},x=Array.isArray||function(d){return Object.prototype.toString.call(d)==="[object Array]"};t.prototype.catch=function(d){return this.then(null,d)},t.prototype.then=function(d,h){var c=this;return new t(function(g,E){o.call(c,new p(d,h,g,E))})},t.all=function(){var d=Array.prototype.slice.call(arguments.length===1&&x(arguments[0])?arguments[0]:arguments);return new t(function(h,c){function g(S,T){try{if(T&&(typeof T=="object"||typeof T=="function")){var N=T.then;if(typeof N=="function")return void N.call(T,function(R){g(S,R)},c)}d[S]=T,--E===0&&h(d)}catch(R){c(R)}}if(d.length===0)return h([]);for(var E=d.length,I=0;I<d.length;I++)g(I,d[I])})},t.resolve=function(d){return d&&typeof d=="object"&&d.constructor===t?d:new t(function(h){h(d)})},t.reject=function(d){return new t(function(h,c){c(d)})},t.race=function(d){return new t(function(h,c){for(var g=0,E=d.length;E>g;g++)d[g].then(h,c)})},t._setImmediateFn=function(d){b=d},i.exports?i.exports=t:e.Promise||(e.Promise=t)})(this)}typeof window<"u"&&typeof window.CustomEvent!="function"&&function(){function e(n,t){t=t||{bubbles:!1,cancelable:!1,detail:void 0};var o=document.createEvent("CustomEvent");return o.initCustomEvent(n,t.bubbles,t.cancelable,t.detail),o}e.prototype=window.Event.prototype,window.CustomEvent=e}(),typeof HTMLCanvasElement<"u"&&!HTMLCanvasElement.prototype.toBlob&&Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(e,n,t){for(var o=atob(this.toDataURL(n,t).split(",")[1]),l=o.length,s=new Uint8Array(l),m=0;m<l;m++)s[m]=o.charCodeAt(m);e(new Blob([s],{type:n||"image/png"}))}});var r=["Webkit","Moz","ms"],u=typeof document<"u"?document.createElement("div").style:{},f=[1,8,3,6],v=[2,7,4,5],C,L,B;function _(e){if(e in u)return e;for(var n=e[0].toUpperCase()+e.slice(1),t=r.length;t--;)if(e=r[t]+n,e in u)return e}L=_("transform"),C=_("transformOrigin"),B=_("userSelect");function H(e,n){var t=f.indexOf(e)>-1?f:v,o=t.indexOf(e),l=n/90%t.length;return t[(t.length+o+l%t.length)%t.length]}function A(e,n){e=e||{};for(var t in n)n[t]&&n[t].constructor&&n[t].constructor===Object?(e[t]=e[t]||{},A(e[t],n[t])):e[t]=n[t];return e}function W(e){return A({},e)}function ce(e,n,t){var o;return function(){var l=this,s=arguments,m=function(){o=null,e.apply(l,s)};clearTimeout(o),o=setTimeout(m,n)}}function K(e){if("createEvent"in document){var n=document.createEvent("HTMLEvents");n.initEvent("change",!1,!0),e.dispatchEvent(n)}else e.fireEvent("onchange")}function M(e,n,t){if(typeof n=="string"){var o=n;n={},n[o]=t}for(var l in n)e.style[l]=n[l]}function D(e,n){e.classList?e.classList.add(n):e.className+=" "+n}function Ee(e,n){e.classList?e.classList.remove(n):e.className=e.className.replace(n,"")}function oe(e,n){for(var t in n)e.setAttribute(t,n[t])}function G(e){return parseInt(e,10)}function kt(e,n){if(!e)throw"Source image missing";var t=new Image;return t.style.opacity="0",new Promise(function(o,l){function s(){t.style.opacity="1",setTimeout(function(){o(t)},1)}t.removeAttribute("crossOrigin"),e.match(/^https?:\/\/|^\/\//)&&t.setAttribute("crossOrigin","anonymous"),t.onload=function(){n?EXIF.getData(t,function(){s()}):s()},t.onerror=function(m){t.style.opacity=1,setTimeout(function(){l(m)},1)},t.src=e})}function Je(e,n){var t=e.naturalWidth,o=e.naturalHeight,l=n||Ae(e);if(l&&l>=5){var s=t;t=o,o=s}return{width:t,height:o}}var Rt={translate3d:{suffix:", 0px"},translate:{suffix:""}},k=function(e,n,t){this.x=parseFloat(e),this.y=parseFloat(n),this.scale=parseFloat(t)};k.parse=function(e){return e.style?k.parse(e.style[L]):e.indexOf("matrix")>-1||e.indexOf("none")>-1?k.fromMatrix(e):k.fromString(e)},k.fromMatrix=function(e){var n=e.substring(7).split(",");return(!n.length||e==="none")&&(n=[1,0,0,1,0,0]),new k(G(n[4]),G(n[5]),parseFloat(n[0]))},k.fromString=function(e){var n=e.split(") "),t=n[0].substring($.globals.translate.length+1).split(","),o=n.length>1?n[1].substring(6):1,l=t.length>1?t[0]:0,s=t.length>1?t[1]:0;return new k(l,s,o)},k.prototype.toString=function(){var e=Rt[$.globals.translate].suffix||"";return $.globals.translate+"("+this.x+"px, "+this.y+"px"+e+") scale("+this.scale+")"};var ue=function(e){if(!e||!e.style[C]){this.x=0,this.y=0;return}var n=e.style[C].split(" ");this.x=parseFloat(n[0]),this.y=parseFloat(n[1])};ue.prototype.toString=function(){return this.x+"px "+this.y+"px"};function Ae(e){return e.exifdata&&e.exifdata.Orientation?G(e.exifdata.Orientation):1}function Qe(e,n,t){var o=n.width,l=n.height,s=e.getContext("2d");switch(e.width=n.width,e.height=n.height,s.save(),t){case 2:s.translate(o,0),s.scale(-1,1);break;case 3:s.translate(o,l),s.rotate(180*Math.PI/180);break;case 4:s.translate(0,l),s.scale(1,-1);break;case 5:e.width=l,e.height=o,s.rotate(90*Math.PI/180),s.scale(1,-1);break;case 6:e.width=l,e.height=o,s.rotate(90*Math.PI/180),s.translate(0,-l);break;case 7:e.width=l,e.height=o,s.rotate(-90*Math.PI/180),s.translate(-o,l),s.scale(1,-1);break;case 8:e.width=l,e.height=o,s.translate(0,o),s.rotate(-90*Math.PI/180);break}s.drawImage(n,0,0,o,l),s.restore()}function Dt(){var e=this,n="croppie-container",t=e.options.viewport.type?"cr-vp-"+e.options.viewport.type:null,o,l,s,m,p,y;e.options.useCanvas=e.options.enableOrientation||Ne.call(e),e.data={},e.elements={},o=e.elements.boundary=document.createElement("div"),s=e.elements.viewport=document.createElement("div"),l=e.elements.img=document.createElement("img"),m=e.elements.overlay=document.createElement("div"),e.options.useCanvas?(e.elements.canvas=document.createElement("canvas"),e.elements.preview=e.elements.canvas):e.elements.preview=l,D(o,"cr-boundary"),o.setAttribute("aria-dropeffect","none"),p=e.options.boundary.width,y=e.options.boundary.height,M(o,{width:p+(isNaN(p)?"":"px"),height:y+(isNaN(y)?"":"px")}),D(s,"cr-viewport"),t&&D(s,t),M(s,{width:e.options.viewport.width+"px",height:e.options.viewport.height+"px"}),s.setAttribute("tabindex",0),D(e.elements.preview,"cr-image"),oe(e.elements.preview,{alt:"preview","aria-grabbed":"false"}),D(m,"cr-overlay"),e.element.appendChild(o),o.appendChild(e.elements.preview),o.appendChild(s),o.appendChild(m),D(e.element,n),e.options.customClass&&D(e.element,e.options.customClass),Pt.call(this),e.options.enableZoom&&At.call(e),e.options.enableResize&&Ht.call(e)}function Ne(){return this.options.enableExif&&window.EXIF}function Ht(){var e=this,n=document.createElement("div"),t=!1,o,l,s,m=50,p,y,w,b;D(n,"cr-resizer"),M(n,{width:this.options.viewport.width+"px",height:this.options.viewport.height+"px"}),this.options.resizeControls.height&&(w=document.createElement("div"),D(w,"cr-resizer-vertical"),n.appendChild(w)),this.options.resizeControls.width&&(b=document.createElement("div"),D(b,"cr-resizer-horisontal"),n.appendChild(b));function x(c){if(!(c.button!==void 0&&c.button!==0)&&(c.preventDefault(),!t)){var g=e.elements.overlay.getBoundingClientRect();if(t=!0,l=c.pageX,s=c.pageY,o=c.currentTarget.className.indexOf("vertical")!==-1?"v":"h",p=g.width,y=g.height,c.touches){var E=c.touches[0];l=E.pageX,s=E.pageY}window.addEventListener("mousemove",d),window.addEventListener("touchmove",d),window.addEventListener("mouseup",h),window.addEventListener("touchend",h),document.body.style[B]="none"}}function d(c){var g=c.pageX,E=c.pageY;if(c.preventDefault(),c.touches){var I=c.touches[0];g=I.pageX,E=I.pageY}var S=g-l,T=E-s,N=e.options.viewport.height+T,R=e.options.viewport.width+S;o==="v"&&N>=m&&N<=y?(M(n,{height:N+"px"}),e.options.boundary.height+=T,M(e.elements.boundary,{height:e.options.boundary.height+"px"}),e.options.viewport.height+=T,M(e.elements.viewport,{height:e.options.viewport.height+"px"})):o==="h"&&R>=m&&R<=p&&(M(n,{width:R+"px"}),e.options.boundary.width+=S,M(e.elements.boundary,{width:e.options.boundary.width+"px"}),e.options.viewport.width+=S,M(e.elements.viewport,{width:e.options.viewport.width+"px"})),fe.call(e),Pe.call(e),me.call(e),se.call(e),s=E,l=g}function h(){t=!1,window.removeEventListener("mousemove",d),window.removeEventListener("touchmove",d),window.removeEventListener("mouseup",h),window.removeEventListener("touchend",h),document.body.style[B]=""}w&&(w.addEventListener("mousedown",x),w.addEventListener("touchstart",x)),b&&(b.addEventListener("mousedown",x),b.addEventListener("touchstart",x)),this.elements.boundary.appendChild(n)}function re(e){if(this.options.enableZoom){var n=this.elements.zoomer,t=J(e,4);n.value=Math.max(parseFloat(n.min),Math.min(parseFloat(n.max),t)).toString()}}function At(){var e=this,n=e.elements.zoomerWrap=document.createElement("div"),t=e.elements.zoomer=document.createElement("input");D(n,"cr-slider-wrap"),D(t,"cr-slider"),t.type="range",t.step="0.0001",t.value="1",t.style.display=e.options.showZoomer?"":"none",t.setAttribute("aria-label","zoom"),e.element.appendChild(n),n.appendChild(t),e._currentZoom=1;function o(){Nt.call(e,{value:parseFloat(t.value),origin:new ue(e.elements.preview),viewportRect:e.elements.viewport.getBoundingClientRect(),transform:k.parse(e.elements.preview)})}function l(s){var m,p;if(e.options.mouseWheelZoom==="ctrl"&&s.ctrlKey!==!0)return 0;s.wheelDelta?m=s.wheelDelta/1200:s.deltaY?m=s.deltaY/1060:s.detail?m=s.detail/-60:m=0,p=e._currentZoom+m*e._currentZoom,s.preventDefault(),re.call(e,p),o.call(e)}e.elements.zoomer.addEventListener("input",o),e.elements.zoomer.addEventListener("change",o),e.options.mouseWheelZoom&&(e.elements.boundary.addEventListener("mousewheel",l),e.elements.boundary.addEventListener("DOMMouseScroll",l))}function Nt(e){var n=this,t=e?e.transform:k.parse(n.elements.preview),o=e?e.viewportRect:n.elements.viewport.getBoundingClientRect(),l=e?e.origin:new ue(n.elements.preview);function s(){var w={};w[L]=t.toString(),w[C]=l.toString(),M(n.elements.preview,w)}if(n._currentZoom=e?e.value:n._currentZoom,t.scale=n._currentZoom,n.elements.zoomer.setAttribute("aria-valuenow",n._currentZoom),s(),n.options.enforceBoundary){var m=Ft.call(n,o),p=m.translate,y=m.origin;t.x>=p.maxX&&(l.x=y.minX,t.x=p.maxX),t.x<=p.minX&&(l.x=y.maxX,t.x=p.minX),t.y>=p.maxY&&(l.y=y.minY,t.y=p.maxY),t.y<=p.minY&&(l.y=y.maxY,t.y=p.minY)}s(),Ot.call(n),se.call(n)}function Ft(e){var n=this,t=n._currentZoom,o=e.width,l=e.height,s=n.elements.boundary.clientWidth/2,m=n.elements.boundary.clientHeight/2,p=n.elements.preview.getBoundingClientRect(),y=p.width,w=p.height,b=o/2,x=l/2,d=(b/t-s)*-1,h=d-(y*(1/t)-o*(1/t)),c=(x/t-m)*-1,g=c-(w*(1/t)-l*(1/t)),E=1/t*b,I=y*(1/t)-E,S=1/t*x,T=w*(1/t)-S;return{translate:{maxX:d,minX:h,maxY:c,minY:g},origin:{maxX:I,minX:E,maxY:T,minY:S}}}function me(e){var n=this,t=n._currentZoom,o=n.elements.preview.getBoundingClientRect(),l=n.elements.viewport.getBoundingClientRect(),s=k.parse(n.elements.preview.style[L]),m=new ue(n.elements.preview),p=l.top-o.top+l.height/2,y=l.left-o.left+l.width/2,w={},b={};if(e){var x=m.x,d=m.y,h=s.x,c=s.y;w.y=x,w.x=d,s.y=h,s.x=c}else w.y=p/t,w.x=y/t,b.y=(w.y-m.y)*(1-t),b.x=(w.x-m.x)*(1-t),s.x-=b.x,s.y-=b.y;var g={};g[C]=w.x+"px "+w.y+"px",g[L]=s.toString(),M(n.elements.preview,g)}function Pt(){var e=this,n=!1,t,o,l,s,m;function p(c,g){var E=e.elements.preview.getBoundingClientRect(),I=m.y+g,S=m.x+c;e.options.enforceBoundary?(s.top>E.top+g&&s.bottom<E.bottom+g&&(m.y=I),s.left>E.left+c&&s.right<E.right+c&&(m.x=S)):(m.y=I,m.x=S)}function y(c){e.elements.preview.setAttribute("aria-grabbed",c),e.elements.boundary.setAttribute("aria-dropeffect",c?"move":"none")}function w(c){var g=37,E=38,I=39,S=40;if(c.shiftKey&&(c.keyCode===E||c.keyCode===S)){var T;c.keyCode===E?T=parseFloat(e.elements.zoomer.value)+parseFloat(e.elements.zoomer.step):T=parseFloat(e.elements.zoomer.value)-parseFloat(e.elements.zoomer.step),e.setZoom(T)}else if(e.options.enableKeyMovement&&c.keyCode>=37&&c.keyCode<=40){c.preventDefault();var N=R(c.keyCode);m=k.parse(e.elements.preview),document.body.style[B]="none",s=e.elements.viewport.getBoundingClientRect(),b(N)}function R(le){switch(le){case g:return[1,0];case E:return[0,1];case I:return[-1,0];case S:return[0,-1]}}}function b(c){var g=c[0],E=c[1],I={};p(g,E),I[L]=m.toString(),M(e.elements.preview,I),fe.call(e),document.body.style[B]="",me.call(e),se.call(e),l=0}function x(c){if(!(c.button!==void 0&&c.button!==0)&&(c.preventDefault(),!n)){if(n=!0,t=c.pageX,o=c.pageY,c.touches){var g=c.touches[0];t=g.pageX,o=g.pageY}y(n),m=k.parse(e.elements.preview),window.addEventListener("mousemove",d),window.addEventListener("touchmove",d),window.addEventListener("mouseup",h),window.addEventListener("touchend",h),document.body.style[B]="none",s=e.elements.viewport.getBoundingClientRect()}}function d(c){c.preventDefault();var g=c.pageX,E=c.pageY;if(c.touches){var I=c.touches[0];g=I.pageX,E=I.pageY}var S=g-t,T=E-o,N={};if(c.type==="touchmove"&&c.touches.length>1){var R=c.touches[0],le=c.touches[1],it=Math.sqrt((R.pageX-le.pageX)*(R.pageX-le.pageX)+(R.pageY-le.pageY)*(R.pageY-le.pageY));l||(l=it/e._currentZoom);var Qt=it/l;re.call(e,Qt),K(e.elements.zoomer);return}p(S,T),N[L]=m.toString(),M(e.elements.preview,N),fe.call(e),o=E,t=g}function h(){n=!1,y(n),window.removeEventListener("mousemove",d),window.removeEventListener("touchmove",d),window.removeEventListener("mouseup",h),window.removeEventListener("touchend",h),document.body.style[B]="",me.call(e),se.call(e),l=0}e.elements.overlay.addEventListener("mousedown",x),e.elements.viewport.addEventListener("keydown",w),e.elements.overlay.addEventListener("touchstart",x)}function fe(){if(this.elements){var e=this,n=e.elements.boundary.getBoundingClientRect(),t=e.elements.preview.getBoundingClientRect();M(e.elements.overlay,{width:t.width+"px",height:t.height+"px",top:t.top-n.top+"px",left:t.left-n.left+"px"})}}var Ot=ce(fe,500);function se(){var e=this,n=e.get();if(et.call(e))if(e.options.update.call(e,n),e.$&&typeof Prototype>"u")e.$(e.element).trigger("update.croppie",n);else{var t;window.CustomEvent?t=new CustomEvent("update",{detail:n}):(t=document.createEvent("CustomEvent"),t.initCustomEvent("update",!0,!0,n)),e.element.dispatchEvent(t)}}function et(){return this.elements.preview.offsetHeight>0&&this.elements.preview.offsetWidth>0}function Fe(){var e=this,n=1,t={},o=e.elements.preview,l,s=new k(0,0,n),m=new ue,p=et.call(e);!p||e.data.bound||(e.data.bound=!0,t[L]=s.toString(),t[C]=m.toString(),t.opacity=1,M(o,t),l=e.elements.preview.getBoundingClientRect(),e._originalImageWidth=l.width,e._originalImageHeight=l.height,e.data.orientation=Ne.call(e)?Ae(e.elements.img):e.data.orientation,e.options.enableZoom?Pe.call(e,!0):e._currentZoom=n,s.scale=e._currentZoom,t[L]=s.toString(),M(o,t),e.data.points.length?Wt.call(e,e.data.points):Ut.call(e),me.call(e),fe.call(e))}function Pe(e){var n=this,t=Math.max(n.options.minZoom,0)||0,o=n.options.maxZoom||1.5,l,s,m=n.elements.zoomer,p=parseFloat(m.value),y=n.elements.boundary.getBoundingClientRect(),w=Je(n.elements.img,n.data.orientation),b=n.elements.viewport.getBoundingClientRect(),x,d;n.options.enforceBoundary&&(x=b.width/w.width,d=b.height/w.height,t=Math.max(x,d)),t>=o&&(o=t+1),m.min=J(t,4),m.max=J(o,4),!e&&(p<m.min||p>m.max)?re.call(n,p<m.min?m.min:m.max):e&&(s=Math.max(y.width/w.width,y.height/w.height),l=n.data.boundZoom!==null?n.data.boundZoom:s,re.call(n,l)),K(m)}function Wt(e){if(e.length!==4)throw"Croppie - Invalid number of points supplied: "+e;var n=this,t=e[2]-e[0],o=n.elements.viewport.getBoundingClientRect(),l=n.elements.boundary.getBoundingClientRect(),s={left:o.left-l.left,top:o.top-l.top},m=o.width/t,p=e[1],y=e[0],w=-1*e[1]+s.top,b=-1*e[0]+s.left,x={};x[C]=y+"px "+p+"px",x[L]=new k(b,w,m).toString(),M(n.elements.preview,x),re.call(n,m),n._currentZoom=m}function Ut(){var e=this,n=e.elements.preview.getBoundingClientRect(),t=e.elements.viewport.getBoundingClientRect(),o=e.elements.boundary.getBoundingClientRect(),l=t.left-o.left,s=t.top-o.top,m=l-(n.width-t.width)/2,p=s-(n.height-t.height)/2,y=new k(m,p,e._currentZoom);M(e.elements.preview,L,y.toString())}function $t(e){var n=this,t=n.elements.canvas,o=n.elements.img,l=t.getContext("2d");l.clearRect(0,0,t.width,t.height),t.width=o.width,t.height=o.height;var s=n.options.enableOrientation&&e||Ae(o);Qe(t,o,s)}function Oe(e){var n=this,t=e.points,o=G(t[0]),l=G(t[1]),s=G(t[2]),m=G(t[3]),p=s-o,y=m-l,w=e.circle,b=document.createElement("canvas"),x=b.getContext("2d"),d=e.outputWidth||p,h=e.outputHeight||y;b.width=d,b.height=h,e.backgroundColor&&(x.fillStyle=e.backgroundColor,x.fillRect(0,0,d,h));var c=o,g=l,E=p,I=y,S=0,T=0,N=d,R=h;return o<0&&(c=0,S=Math.abs(o)/p*d),E+c>n._originalImageWidth&&(E=n._originalImageWidth-c,N=E/p*d),l<0&&(g=0,T=Math.abs(l)/y*h),I+g>n._originalImageHeight&&(I=n._originalImageHeight-g,R=I/y*h),x.drawImage(this.elements.preview,c,g,E,I,S,T,N,R),w&&(x.fillStyle="#fff",x.globalCompositeOperation="destination-in",x.beginPath(),x.arc(b.width/2,b.height/2,b.width/2,0,Math.PI*2,!0),x.closePath(),x.fill()),b}function zt(e){var n=e.points,t=document.createElement("div"),o=document.createElement("img"),l=n[2]-n[0],s=n[3]-n[1];return D(t,"croppie-result"),t.appendChild(o),M(o,{left:-1*n[0]+"px",top:-1*n[1]+"px"}),o.src=e.url,M(t,{width:l+"px",height:s+"px"}),t}function Zt(e){return Oe.call(this,e).toDataURL(e.format,e.quality)}function Xt(e){var n=this;return new Promise(function(t){Oe.call(n,e).toBlob(function(o){t(o)},e.format,e.quality)})}function jt(e){this.elements.img.parentNode&&(Array.prototype.forEach.call(this.elements.img.classList,function(n){e.classList.add(n)}),this.elements.img.parentNode.replaceChild(e,this.elements.img),this.elements.preview=e),this.elements.img=e}function tt(e,n){var t=this,o,l=[],s=null,m=Ne.call(t);if(typeof e=="string")o=e,e={};else if(Array.isArray(e))l=e.slice();else{if(typeof e>"u"&&t.data.url)return Fe.call(t),se.call(t),null;o=e.url,l=e.points||[],s=typeof e.zoom>"u"?null:e.zoom}return t.data.bound=!1,t.data.url=o||t.data.url,t.data.boundZoom=s,kt(o,m).then(function(p){if(jt.call(t,p),l.length)t.options.relative&&(l=[l[0]*p.naturalWidth/100,l[1]*p.naturalHeight/100,l[2]*p.naturalWidth/100,l[3]*p.naturalHeight/100]);else{var y=Je(p),w=t.elements.viewport.getBoundingClientRect(),b=w.width/w.height,x=y.width/y.height,d,h;x>b?(h=y.height,d=h*b):(d=y.width,h=y.height/b);var c=(y.width-d)/2,g=(y.height-h)/2,E=c+d,I=g+h;t.data.points=[c,g,E,I]}t.data.orientation=e.orientation||1,t.data.points=l.map(function(S){return parseFloat(S)}),t.options.useCanvas&&$t.call(t,t.data.orientation),Fe.call(t),se.call(t),n&&n()})}function J(e,n){return parseFloat(e).toFixed(n||0)}function nt(){var e=this,n=e.elements.preview.getBoundingClientRect(),t=e.elements.viewport.getBoundingClientRect(),o=t.left-n.left,l=t.top-n.top,s=(t.width-e.elements.viewport.offsetWidth)/2,m=(t.height-e.elements.viewport.offsetHeight)/2,p=o+e.elements.viewport.offsetWidth+s,y=l+e.elements.viewport.offsetHeight+m,w=e._currentZoom;(w===1/0||isNaN(w))&&(w=1);var b=e.options.enforceBoundary?0:Number.NEGATIVE_INFINITY;return o=Math.max(b,o/w),l=Math.max(b,l/w),p=Math.max(b,p/w),y=Math.max(b,y/w),{points:[J(o),J(l),J(p),J(y)],zoom:w,orientation:e.data.orientation}}var qt={type:"canvas",format:"png",quality:1},Yt=["jpeg","webp","png"];function Vt(e){var n=this,t=nt.call(n),o=A(W(qt),W(e)),l=typeof e=="string"?e:o.type||"base64",s=o.size||"viewport",m=o.format,p=o.quality,y=o.backgroundColor,w=typeof o.circle=="boolean"?o.circle:n.options.viewport.type==="circle",b=n.elements.viewport.getBoundingClientRect(),x=b.width/b.height,d;return s==="viewport"?(t.outputWidth=b.width,t.outputHeight=b.height):typeof s=="object"&&(s.width&&s.height?(t.outputWidth=s.width,t.outputHeight=s.height):s.width?(t.outputWidth=s.width,t.outputHeight=s.width/x):s.height&&(t.outputWidth=s.height*x,t.outputHeight=s.height)),Yt.indexOf(m)>-1&&(t.format="image/"+m,t.quality=p),t.circle=w,t.url=n.data.url,t.backgroundColor=y,d=new Promise(function(h){switch(l.toLowerCase()){case"rawcanvas":h(Oe.call(n,t));break;case"canvas":case"base64":h(Zt.call(n,t));break;case"blob":Xt.call(n,t).then(h);break;default:h(zt.call(n,t));break}}),d}function Kt(){Fe.call(this)}function Gt(e){if(!this.options.useCanvas||!this.options.enableOrientation)throw"Croppie: Cannot rotate without enableOrientation && EXIF.js included";var n=this,t=n.elements.canvas;if(n.data.orientation=H(n.data.orientation,e),Qe(t,n.elements.img,n.data.orientation),me.call(n,!0),Pe.call(n),Math.abs(e)/90%2===1){var o=n._originalImageHeight,l=n._originalImageWidth;n._originalImageWidth=o,n._originalImageHeight=l}}function Jt(){var e=this;e.element.removeChild(e.elements.boundary),Ee(e.element,"croppie-container"),e.options.enableZoom&&e.element.removeChild(e.elements.zoomerWrap),delete e.elements}if(typeof window<"u"&&window.jQuery){var Q=window.jQuery;Q.fn.croppie=function(e){var n=typeof e;if(n==="string"){var t=Array.prototype.slice.call(arguments,1),o=Q(this).data("croppie");return e==="get"?o.get():e==="result"?o.result.apply(o,t):e==="bind"?o.bind.apply(o,t):this.each(function(){var l=Q(this).data("croppie");if(l){var s=l[e];if(Q.isFunction(s))s.apply(l,t),e==="destroy"&&Q(this).removeData("croppie");else throw"Croppie "+e+" method not found"}})}else return this.each(function(){var l=new $(this,e);l.$=Q,Q(this).data("croppie",l)})}}function $(e,n){if(e.className.indexOf("croppie-container")>-1)throw new Error("Croppie: Can't initialize croppie more than once");if(this.element=e,this.options=A(W($.defaults),n),this.element.tagName.toLowerCase()==="img"){var t=this.element;D(t,"cr-original-image"),oe(t,{"aria-hidden":"true",alt:""});var o=document.createElement("div");this.element.parentNode.appendChild(o),o.appendChild(t),this.element=o,this.options.url=this.options.url||t.src}if(Dt.call(this),this.options.url){var l={url:this.options.url,points:this.options.points};delete this.options.url,delete this.options.points,tt.call(this,l)}}return $.defaults={viewport:{width:100,height:100,type:"square"},boundary:{},orientationControls:{enabled:!0,leftClass:"",rightClass:""},resizeControls:{width:!0,height:!0},customClass:"",showZoomer:!0,enableZoom:!0,enableResize:!1,mouseWheelZoom:!0,enableExif:!1,enforceBoundary:!0,enableOrientation:!1,enableKeyMovement:!0,update:function(){}},$.globals={translate:"translate3d"},A($.prototype,{bind:function(e,n){return tt.call(this,e,n)},get:function(){var e=nt.call(this),n=e.points;return this.options.relative&&(n[0]/=this.elements.img.naturalWidth/100,n[1]/=this.elements.img.naturalHeight/100,n[2]/=this.elements.img.naturalWidth/100,n[3]/=this.elements.img.naturalHeight/100),e},result:function(e){return Vt.call(this,e)},refresh:function(){return Kt.call(this)},setZoom:function(e){re.call(this,e),K(this.elements.zoomer)},rotate:function(e){Gt.call(this,e)},destroy:function(){return Jt.call(this)}}),$})}(he,he.exports)),he.exports}var vn=gn();const wn=nn(vn);F.defaults.headers.common["X-CSRF-TOKEN"]=document.querySelector('meta[name="csrf-token"]').content;F.defaults.headers.common["Content-Type"]="application/json";let ne,ut,ye,mt,ft,Be,Mt,Re,Me,ht,pt,pe,gt,X,ge,ee,He,_t,vt,wt,ve,we,St,O=null,Z=null,U=[];window.addEventListener("load",function(){initProductSection()});window.initProductSection=()=>{ne=document.getElementById("product-list"),ut=document.getElementById("add-product-btn"),ye=document.getElementById("product-modal"),ft=document.getElementById("cancel-btn"),Be=document.getElementById("product-form"),Mt=document.getElementById("modal-title"),Re=document.getElementById("product-id"),Me=document.getElementById("delete-confirm-modal"),ht=document.getElementById("cancel-delete-btn"),pt=document.getElementById("confirm-delete-btn"),pe=document.getElementById("pagination-controls"),gt=document.getElementById("menu-button"),mt=document.getElementById("close-product-modal"),gt.classList.remove("hidden"),X=document.getElementById("image-upload-area"),ge=document.getElementById("upload-text"),ee=document.getElementById("image-input"),He=document.getElementById("image-editor-container"),_t=document.getElementById("croppie-container"),vt=document.getElementById("rotate-right-btn"),wt=document.querySelectorAll(".ratio-btn"),yt(),ut.addEventListener("click",()=>Tt("Agregar Nuevo Vehículo")),ft.addEventListener("click",xe),mt.addEventListener("click",xe),ht.addEventListener("click",$e),ye.addEventListener("click",i=>i.target===ye&&xe()),Me.addEventListener("click",i=>i.target===Me&&$e()),Be.addEventListener("submit",async i=>{i.preventDefault();const a=Be.querySelector('button[type="submit"]');a.disabled=!0;const r=a.innerHTML;a.innerHTML='<span class="loader"></span>';const u={brand:document.getElementById("brand").value,model:document.getElementById("model").value,year:document.getElementById("year").value,price:document.getElementById("price").value,description:document.getElementById("description").value},f=Re.value;f&&(u.product_id=f);const v=async()=>{if(O)try{const B=await O.result({type:"base64",format:"webp",size:"viewport"});u.image=B;const _=O.get();u.croppie_points=JSON.stringify(_.points||[]),u.croppie_zoom=_.zoom,u.croppie_orientation=_.orientation,u.croppie_viewport=JSON.stringify({width:ve,height:we,ratio:St})}catch(B){console.error("Error al obtener la imagen recortada:",B)}},C=async()=>{try{await F.post("/panel/save_product",u),xe(),await yt(!f)}catch(B){console.error("Error al guardar producto:",B)}finally{a.disabled=!1,a.innerHTML=r}},L=ee.files[0];if(L){const B=new FileReader;B.onload=async _=>{u.original_image=_.target.result,await v(),await C()},B.readAsDataURL(L)}else await v(),await C()}),pt.addEventListener("click",()=>{if(je){U=U.filter(a=>a.id!=je);const i=Math.ceil(U.length/de);P>i&&i>0&&(P=i),be(),$e()}}),ee.addEventListener("change",i=>{const a=i.target.files[0];if(!a)return;const r=new FileReader;r.onload=function(u){Z=u.target.result,_e(Z,"1:1")},r.readAsDataURL(a)}),vt.addEventListener("click",()=>{O&&O.rotate(90)}),wt.forEach(i=>{i.addEventListener("click",a=>{const r=a.target.dataset.ratio;Z&&_e(Z,r)})}),X.addEventListener("click",()=>{ee.click()}),ee.addEventListener("change",()=>{ee.files.length>0?ge.textContent=`Archivo seleccionado: ${ee.files[0].name}`:ge.textContent="Haz clic para subir una imagen o arrástrala aquí."}),X.addEventListener("dragover",i=>{i.preventDefault(),i.stopPropagation(),X.classList.add("border-blue-500")}),X.addEventListener("dragleave",i=>{i.preventDefault(),i.stopPropagation(),X.classList.remove("border-blue-500")}),X.addEventListener("drop",i=>{i.preventDefault(),i.stopPropagation(),X.classList.remove("border-blue-500");const a=i.dataTransfer.files;if(a.length>0){ge.textContent=`Archivo seleccionado: ${a[0].name}`;const r=a[0],u=new FileReader;u.onload=function(f){Z=f.target.result,_e(Z,"1:1")},u.readAsDataURL(r)}})};async function yt(i=!1){En();try{U=(await F.get("/panel/get_products")).data,i&&(P=Math.ceil(U.length/de)),be()}catch(a){console.error("Error al cargar productos:",a)}}let je=null,P=1;const de=8,yn=i=>new Intl.NumberFormat("es-CL",{style:"currency",currency:"CLP"}).format(i),bt=(i,a)=>`https://placehold.co/600x400/94a3b8/ffffff?text=${encodeURIComponent(i)}+${encodeURIComponent(a)}`,be=()=>{ne.innerHTML="";const i=(P-1)*de,a=i+de,r=U.slice(i,a);r.length===0&&U.length>0?ne.innerHTML='<p class="col-span-full text-center text-gray-500">No hay vehículos en esta página.</p>':U.length===0?ne.innerHTML='<p class="col-span-full text-center text-gray-500">No hay vehículos en el inventario.</p>':r.forEach(f=>{const v=document.createElement("div");v.className="bg-white rounded-xl shadow-lg overflow-hidden transform hover:-translate-y-1 transition-all duration-300 flex flex-col";const C=f.url_image?`/storage/${f.url_image}`:bt(f.brand,f.model);v.innerHTML=`
                            <img src="${C}" alt="${f.brand} ${f.model}" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='${bt(f.brand,f.model)}';">
                            <div class="p-4 flex flex-col flex-grow">
                                <h3 class="text-lg font-bold">${f.brand} ${f.model}</h3>
                                <p class="text-gray-600">${f.year}</p>
                                <p class="text-xl font-semibold text-blue-600 mt-2">${yn(f.price)}</p>
                                <div class="mt-4 flex justify-end space-x-2 mt-auto">
                                    <button class="edit-btn p-2 rounded-full hover:bg-gray-200 transition-colors" data-id="${f.id}" title="Editar">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                    </button>
                                    <button class="delete-btn p-2 rounded-full hover:bg-gray-200 transition-colors" data-id="${f.id}" title="Eliminar">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    </button>
                                </div>
                            </div>
                        `,ne.appendChild(v)}),bn(),document.querySelectorAll(".edit-btn").forEach(f=>{f.addEventListener("click",()=>{const v=f.dataset.id,C=U.find(L=>L.id==v);C&&Tt("Editar Vehículo",C)})})},bn=()=>{pe.innerHTML="";const i=Math.ceil(U.length/de);if(i<=1)return;const a=document.createElement("button");a.innerHTML="&laquo;",a.className="pagination-btn",a.disabled=P===1,a.addEventListener("click",()=>{P>1&&(P--,be())}),pe.appendChild(a);for(let u=1;u<=i;u++){const f=document.createElement("button");f.textContent=u,f.className="pagination-btn",u===P&&f.classList.add("active"),f.addEventListener("click",()=>{P=u,be()}),pe.appendChild(f)}const r=document.createElement("button");r.innerHTML="&raquo;",r.className="pagination-btn",r.disabled=P===i,r.addEventListener("click",()=>{P<i&&(P++,be())}),pe.appendChild(r)},Tt=(i,a=null)=>{xn(),Mt.textContent=i,ge.textContent="Haz clic para subir una imagen o arrástrala aquí.",Be.reset(),Re.value="",a&&(Re.value=a.id,document.getElementById("brand").value=a.brand,document.getElementById("model").value=a.model,document.getElementById("year").value=a.year,document.getElementById("price").value=a.price,document.getElementById("description").value=a.description||"",a.url_original_image&&(He.classList.remove("hidden"),fetch(`/storage/${a.url_original_image}`).then(r=>r.blob()).then(r=>{const u=new FileReader;u.onloadend=()=>{Z=u.result;const f=a.croppie_viewport?JSON.parse(a.croppie_viewport):{ratio:"1:1"},v=a.croppie_points?JSON.parse(a.croppie_points):null,C=a.croppie_zoom||1,L=a.croppie_orientation||0;_e(Z,f.ratio,v,C,L)},u.readAsDataURL(r)}).catch(r=>console.error("Error al cargar la imagen:",r)))),ye.classList.remove("hidden")},xe=()=>ye.classList.add("hidden"),$e=()=>{je=null,Me.classList.add("hidden")},En=(i=de)=>{ne.innerHTML="";for(let a=0;a<i;a++){const r=document.createElement("div");r.className="bg-white rounded-xl shadow-lg overflow-hidden animate-pulse flex flex-col",r.innerHTML=`
            <div class="bg-gray-300 w-full h-48"></div>
            <div class="p-4 flex flex-col flex-grow space-y-2">
                <div class="h-6 bg-gray-300 rounded w-3/4"></div>
                <div class="h-4 bg-gray-300 rounded w-1/2"></div>
                <div class="h-6 bg-gray-300 rounded w-1/3 mt-auto"></div>
            </div>
        `,ne.appendChild(r)}};function xn(){O&&(O.destroy(),O=null),He.classList.add("hidden"),Z=null}function _e(i,a="1:1",r=null,u=null,f=0){O&&O.destroy(),St=a,a==="16:9"?(ve=280,we=157.5):a==="4:3"?(ve=250,we=187.5):(ve=250,we=250),He.classList.remove("hidden"),O=new wn(_t,{viewport:{width:ve,height:we},boundary:{width:"100%",height:"100%"},enableOrientation:!0}),O.bind({url:i,points:r,zoom:u,orientation:f})}document.addEventListener("DOMContentLoaded",()=>{const i=document.getElementById("menu-button"),a=document.getElementById("close-menu-button"),r=document.getElementById("app-container"),u=document.getElementById(`btn-${currentMenu}`);u&&u.classList.add("bg-gray-700"),i&&r&&i.addEventListener("click",()=>{r.classList.add("nav-active")}),a&&r&&a.addEventListener("click",()=>{r.classList.remove("nav-active")})});const Et=document.getElementById("main-content"),qe={chat:{url:"/panel/chats",init:window.initChatSection,btn:document.getElementById("btn-chat")},users:{url:"/panel/users",init:window.initUserSection,btn:document.getElementById("btn-users")},products:{url:"/panel/products",init:window.initProductSection,btn:document.getElementById("btn-products")}};let Ce=null;async function Cn(i){const a=qe[i];if(a&&window.currentMenu!==i){window.currentMenu=i,Ce&&Ce.abort(),Ce=new AbortController,document.querySelectorAll(".menu-btn").forEach(r=>{r.classList.remove("bg-gray-700")}),a.btn&&a.btn.classList.add("bg-gray-700"),Et.innerHTML=`
        <div class="flex items-center justify-center w-full h-full">
            <div class="flex flex-col items-center">
                <div class="w-12 h-12 border-4 border-gray-300 border-t-gray-500 rounded-full animate-spin"></div>
                <span class="mt-4 text-gray-500">Cargando...</span>
            </div>
        </div>
    `;try{const r=await F.get(a.url,{signal:Ce.signal});Et.innerHTML=r.data,typeof a.init=="function"&&a.init()}catch(r){r.name==="CanceledError"||r.name==="AbortError"?console.log("Petición cancelada"):console.error("Error cargando sección:",r)}}}Object.keys(qe).forEach(i=>{const a=qe[i];a.btn&&a.btn.addEventListener("click",()=>Cn(i))});window.highlightSelectedItem=(i,a)=>{document.querySelectorAll(i).forEach(r=>{r.dataset.chatId===String(a)||r.dataset.userId===String(a)?(r.classList.add("bg-indigo-50","border-l-4","border-indigo-500","border-l-indigo-500"),r.classList.remove("border-b","border","divide-y")):r.classList.remove("bg-indigo-50","border-l-4","border-indigo-500","border-l-indigo-500")})};
